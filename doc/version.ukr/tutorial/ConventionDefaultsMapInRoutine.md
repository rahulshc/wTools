# Routines call convention: routine defaults map

Як зберігаються та змінюються налаштування за замовчуванням в рутинах.

Зберігання налаштувань за замовчуванням в рутинах здійснюється з допомогою спеціальних [мап опцій](../concept/MapOptions.md) `defaults`. Мапи опцій `defaults` містять повний набір параметрів для рутини. При цьому налаштування за замовчуванням можуть використовуватись рутиною безпосередньо, або ж при передачі значень в іншу рутину.

### Виклик рутини, що містить мапу опцій `defaults`

В залежності від реалізації рутини, що містить мапу опцій `defaults`, є два способи виклику:

- виклик рутини з передачею значень в аргументах;
- виклик рутини з передачею мапи опцій.

Крім цього, є окремі рутини, котрі здатні приймати параметром і мапу опцій, і масив аргументів.

<details>
  <summary><u>Структура файлів</u></summary>

```
defaults
    ├── DefaultsInRoutine.js
    └── package.json
```

</details>

Для дослідження варіантів виклику рутин з мапою `defaults`, створіть приведену вище конфігурацію.

В прикладах використовується модуль `Tools`. Тому, скопіюйте приведений нижче код в файл `package.json`.

<details>
    <summary><u>Код файла <code>package.json</code></u></summary>

```json    
{
  "dependencies": {
    "wTools": ""
  }
}
```

</details>

Для встановлення залежностей скористуйтесь командою `npm install`. Після встановлення залежностей модуль готовий до роботи.  

### Рутина, що не змінює налаштування за замовчуванням

<details>
    <summary><u>Код файла <code>DefaultsInRoutine.js</code></u></summary>

```js
let _ = require( 'wTools' );

//

function nameFull( path )
{
  _.assert( arguments.length === 1 );
  _.assert( _.strIs( path ), 'Expects strings {-path-}' );

  let o = { path : path };
  _.routineOptions( nameFull, o );

  let i = o.path.lastIndexOf( '/' );
  if( i !== -1 )
  o.path = o.path.substr( i+1 );

  if( !o.full )
  {
    let i = o.path.lastIndexOf( '.' );
    if( i !== -1 ) o.path = o.path.substr( 0, i );
  }

  return o.path;
}

nameFull.defaults =
{
  path : null,
  full : 1,
}

//

console.log( nameFull( '/foo/bar/baz.js' ) );
```

</details>

Внесіть в файл `DefaultsInRoutine.js` приведений вище код.

Код рутини `nameFull` представляє спрощену реалізацію рутини з постійними налаштуваннями за замовчуванням, мапа опцій `defaults` є лише контейнером для зберігання налаштувань рутини `nameFull`. Постійні налаштування за замовчуванням зручні при створенні рутин, що мають спільний код, а поведінка відрізняється за рахунок встановлених опцій. Як створювати множину рутин з відмінними налаштуваннями за замовчуванням можна дізнатись в [туторіалі](./RoutineFromPreAndBody.md).

В мапі опцій `defaults` поміщаються всі параметри рутини. Рутина `nameFull` включає два параметри - `path` i `full`. Параметр `path` передається в аргумент рутини `nameFull` тому в мапі `defaults` він має значення `null`. В рядку

```js
let o = { path : path };
```

аргумент поміщається в мапу опцій за ключем `path`.

Рутина `routineOptions` порівнює встановлені в рутині (або передані) опції з опціями в мапі `defaults`. Якщо в мапі `defaults` є опції, що не встановлені в рутині, то `routineOptions` присвоює їх рутині. Опція `full` має постійне значення `1`, вона не передається через аргумент, і не встановлюється рутиною, тому `routineOptions` присвоює опцію рутині `nameFull`.

<details>
  <summary><u>Вивід команди <code>node DefaultsInRoutine.js</code></u></summary>

```
$ node DefaultsInRoutine.js
baz.js
```

</details>

Запустіть виконання файла командою `node DefaultsInRoutine.js`. Порівняйте вивід з приведеним вище.

Рутина `nameFull` відділила повну назву файла з указаного шляху. Змініть опцію `full : 1` на `full : 0` та повторіть виконання файла.

<details>
  <summary><u>Вивід команди <code>node DefaultsInRoutine.js</code></u></summary>

```
$ node DefaultsInRoutine.js
baz
```

</details>

Тепер рутина виділяє лише ім'я файла, без розширення.

Статичні опції в мапі `defaults`, дозволяють створювати нові рутини з однаковим кодом але різною поведінкою.

### Рутини, котрі змінюють налаштування за замовчуванням

Для збільшення гнучкості, рутини можуть встановлювати налаштування за замовчуванням з переданих аргументів. Така рутина може приймати готову мапу опцій, або перетворювати передані аргументи в мапу опцій.

<details>
    <summary><u>Код файла <code>DefaultsInRoutine.js</code></u></summary>

```js
let _ = require( 'wTools' );

//

function name( o )
{
  _.assert( arguments.length === 1 );
  _.assert( _.mapIs( o ), 'Expects map' );

  _.routineOptions( name, o );

  let i = o.path.lastIndexOf( '/' );
  if( i !== -1 )
  o.path = o.path.substr( i+1 );

  if( !o.full )
  {
    let i = o.path.lastIndexOf( '.' );
    if( i !== -1 ) o.path = o.path.substr( 0, i );
  }

  return o.path;
}

name.defaults =
{
  path : null,
  full : 0,
}

//

console.log( name( { path : '/foo/bar/baz.js' } ) );
console.log( name( { path : '/foo/bar/baz.js', full : 1 } ) );
```

</details>

Замініть код в файлі `DefaultsInRoutine.js` на приведений вище.

Оновлений код описує рутину `name`. Рутина приймає мапу опції, це дозволяє передавати опції `path` i `full` відразу в мапі, та динамічно змінювати поведінку рутини `name`.

<details>
  <summary><u>Вивід команди <code>node DefaultsInRoutine.js</code></u></summary>

```
$ node DefaultsInRoutine.js
baz
baz.js
```

</details>

Запустіть виконання файла командою `node DefaultsInRoutine.js`. Порівняйте вивід з приведеним вище.

В першому рядку виводу показано, що при передачі шляху без указання опції `full`, присвоюється значення за замовчуванням і рутина повертає ім'я файла без розширення. В другому рядку було встановлено опцію `full` i тому рутина вивела повне ім'я.

### Рутини з налаштуваннями за замовчуванням, що мають контекст виклику

Зазвичай рутини модуля `Tools` викликаються в його власному контексті, а тому окремі опції можуть бути визначені властивостями модуля. Окремі рутини мають налаштування за замовчуванням, котрі можна змінити лише зміною контексту виклику. Наприклад, до таких рутин належать деякі рутини для обробки мап.

Рутина `mapKeys` буде розглянута, як приклад рутини що може змінювати налаштування за замовчуванням при зміні контексту. Рутина `mapKeys` приймає аргументом мапу опцій `srcMap` та формує масив, що містить перелік ключів, що містяться в мапі. Рутина має таку мапу `defaults`

```js
mapKeys.defaults =
{
  own : 0,
  enumerable : 1,
}
```

Опція `own` відповідає за пошук власних (не наслідуваних) ключів, а опція `enumerable` встановлює можливість фільтрації ключів в масиві.

<details>
    <summary><u>Код файла <code>DefaultsInRoutine.js</code></u></summary>

```js
let _ = require( 'wTools' );

//

let o = { own : 1 };

var a = { a : 1 }
var b = { b : 2 }
Object.setPrototypeOf( a, b );

console.log( _.mapKeys( a ) );
console.log( _.mapKeys.call( o, a ) );
```

</details>

Внесіть в файл приведений код.

В коді файлу створено мапу `o`, котра містить значення `own : 1`. Створено мапи опцій `a` та `b`. В рядку

```js
Object.setPrototypeOf( a, b );
```

через через присвоєння прототипу до мапи `a` додано властивість з мапи `b`.

<details>
  <summary><u>Вивід команди <code>node DefaultsInRoutine.js</code></u></summary>

```
$ node DefaultsInRoutine.js
[ 'a', 'b' ]
[ 'a' ]
```

</details>

Запустіть виконання файла та порівняйте вивід з приведеним.

В першому рядку виведено масив з двома ключами - `[ 'a', 'b' ]`, тобто, рутина `mapKeys` використала налаштування за замовчуванням. Другий рядок вивів масив з одним ключем, власним ключем мапи `a`. Відповідно, в другому випадку рутина `mapKeys` змінила поведінку за рахунок того, що метод `call` змінив контекст виклику з конструктора класу на мапу `o`. В свою чергу, це дозволило замінити значення опції `own : 0` на `own : 1`.

### Підсумок

- Мапа опцій `defaults` призначена для зберігання налаштувань за замовчуванням.
- Мапа опцій `defaults` містить повний перелік параметрів рутини.
- Опції в мапі `defaults` можуть змінюватись в залежності від переданих аргументів або залишатись незмінними (статичними).
- Зміною статичних налаштувань в мапі `defaults` можна створювати нові рутини, що мають спільний код, але різну поведінку.
- Налаштування в рутину можуть передаватись через масив аргументів або мапу опцій. Мапа опцій зручніша в використанні
- Опції, що передаються через аргументи рутини або мапу опцій забезпечують високу гнучкість при використанні рутин.
- Окремі рутини модуля можуть змінювати налаштування за замовчуванням в залежності від контексту виклику.
